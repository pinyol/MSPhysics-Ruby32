name: Build MSPhysics C++ Extensions

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows x64
    runs-on: windows-latest
    
    steps:
    - name: Checkout MSPhysics
      uses: actions/checkout@v4
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
        
    - name: Build Newton Dynamics
      working-directory: C++Extension/Projects/VS
      run: |
        msbuild newton.vcxproj /t:Rebuild /p:Configuration="Release" /p:Platform="x64" /p:WindowsTargetPlatformVersion="10.0" /p:PlatformToolset="v143"
        
    - name: Build MSPhysics Extension (Ruby 2.5)
      working-directory: C++Extension/Projects/VS
      run: |
        msbuild msp_lib.vcxproj /t:Rebuild /p:Configuration="Release (2.5)" /p:Platform="x64" /p:WindowsTargetPlatformVersion="10.0" /p:PlatformToolset="v143"
        
    - name: Package Windows Binaries
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path "build-output/windows-x64"
        
        # Find and copy the built files
        $mspLib = Get-ChildItem -Path "C++Extension/Projects/VS/x64" -Recurse -Filter "msp_lib.so" | Select-Object -First 1
        if ($mspLib) {
          Copy-Item $mspLib.FullName "build-output/windows-x64/"
          Write-Host "Copied: $($mspLib.FullName)"
        } else {
          Write-Host "ERROR: msp_lib.so not found!"
          Get-ChildItem -Path "C++Extension/Projects/VS/x64" -Recurse
          exit 1
        }
        
        $newtonDll = Get-ChildItem -Path "C++Extension/Projects/VS/x64" -Recurse -Filter "newton.dll" | Select-Object -First 1
        if ($newtonDll) {
          Copy-Item $newtonDll.FullName "build-output/windows-x64/"
          Write-Host "Copied: $($newtonDll.FullName)"
        }
        
        # Copy SDL2 dependencies
        if (Test-Path "C++Extension/ThirdParty/SDL2/lib/x64") {
          Copy-Item "C++Extension/ThirdParty/SDL2/lib/x64/*.dll" "build-output/windows-x64/" -ErrorAction SilentlyContinue
        }
        if (Test-Path "C++Extension/ThirdParty/SDL2_mixer/lib/x64") {
          Copy-Item "C++Extension/ThirdParty/SDL2_mixer/lib/x64/*.dll" "build-output/windows-x64/" -ErrorAction SilentlyContinue
        }
        
        Write-Host "`nFinal package contents:"
        Get-ChildItem "build-output/windows-x64"
        
    - name: Upload Windows Binaries
      uses: actions/upload-artifact@v4
      with:
        name: msphysics-windows-x64
        path: build-output/windows-x64/*
        retention-days: 30

  build-macos:
    name: Build macOS Universal
    runs-on: macos-latest
    
    steps:
    - name: Checkout MSPhysics
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Build Newton Dynamics
      working-directory: C++Extension/Projects/xCode
      run: |
        xcodebuild -project newton.xcodeproj \
          -target "newton - 64" \
          -configuration Release \
          -arch x86_64 -arch arm64 \
          ONLY_ACTIVE_ARCH=NO \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          MACOSX_DEPLOYMENT_TARGET=10.13 \
          BUILD_DIR="$(pwd)/build"
          
    - name: Build MSPhysics Extension
      working-directory: C++Extension/Projects/xCode
      run: |
        # Note: No parentheses in scheme name!
        xcodebuild -project msp_lib.xcodeproj \
          -target "Ruby 2.5 - 64" \
          -configuration Release \
          -arch x86_64 -arch arm64 \
          ONLY_ACTIVE_ARCH=NO \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          MACOSX_DEPLOYMENT_TARGET=10.13 \
          BUILD_DIR="$(pwd)/build"
          
    - name: Package macOS Binaries
      run: |
        mkdir -p "build-output/macos-universal"
        
        # Find and copy the built bundle
        bundle_path=$(find "C++Extension/Projects/xCode/build" -name "msp_lib.bundle" | head -1)
        if [ -n "$bundle_path" ]; then
          cp -R "$bundle_path" "build-output/macos-universal/"
          echo "Copied: $bundle_path"
          
          # Check if it's universal
          if [ -f "build-output/macos-universal/msp_lib.bundle/Contents/MacOS/msp_lib" ]; then
            echo "Architecture info:"
            lipo -info "build-output/macos-universal/msp_lib.bundle/Contents/MacOS/msp_lib"
          fi
        else
          echo "ERROR: msp_lib.bundle not found!"
          find "C++Extension/Projects/xCode/build" -type f
          exit 1
        fi
        
        # Find and copy newton dylib
        dylib_path=$(find "C++Extension/Projects/xCode/build" -name "*.dylib" | head -1)
        if [ -n "$dylib_path" ]; then
          cp "$dylib_path" "build-output/macos-universal/"
          echo "Copied: $dylib_path"
        fi
        
        # Copy SDL2 dependencies if available
        [ -d "C++Extension/ThirdParty/SDL2/lib/osx" ] && cp C++Extension/ThirdParty/SDL2/lib/osx/*.dylib "build-output/macos-universal/" 2>/dev/null || true
        [ -d "C++Extension/ThirdParty/SDL2_mixer/lib/osx" ] && cp C++Extension/ThirdParty/SDL2_mixer/lib/osx/*.dylib "build-output/macos-universal/" 2>/dev/null || true
        
        echo -e "\nFinal package contents:"
        ls -la "build-output/macos-universal"
        
    - name: Upload macOS Binaries
      uses: actions/upload-artifact@v4
      with:
        name: msphysics-macos-universal
        path: build-output/macos-universal/*
        retention-days: 30

  package-plugin:
    name: Package Complete Plugin
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout MSPhysics
      uses: actions/checkout@v4
      
    - name: Download Windows Binaries
      uses: actions/download-artifact@v4
      with:
        name: msphysics-windows-x64
        path: binaries/windows-x64
        
    - name: Download macOS Binaries
      uses: actions/download-artifact@v4
      with:
        name: msphysics-macos-universal
        path: binaries/macos-universal
        
    - name: Organize Plugin Structure
      run: |
        mkdir -p plugin/MSPhysics/libraries/stage/win64/2.5
        mkdir -p plugin/MSPhysics/libraries/stage/osx64/2.5
        
        # Copy Windows binaries
        if [ -f "binaries/windows-x64/msp_lib.so" ]; then
          cp binaries/windows-x64/msp_lib.so plugin/MSPhysics/libraries/stage/win64/2.5/
          echo "âœ“ Windows msp_lib.so"
        fi
        
        if [ -f "binaries/windows-x64/newton.dll" ]; then
          cp binaries/windows-x64/newton.dll plugin/MSPhysics/libraries/stage/win64/
          echo "âœ“ Windows newton.dll"
        fi
        
        cp binaries/windows-x64/*.dll plugin/MSPhysics/libraries/stage/win64/ 2>/dev/null || true
        
        # Copy macOS binaries
        if [ -d "binaries/macos-universal/msp_lib.bundle" ]; then
          cp -R binaries/macos-universal/msp_lib.bundle plugin/MSPhysics/libraries/stage/osx64/2.5/
          echo "âœ“ macOS msp_lib.bundle"
        fi
        
        cp binaries/macos-universal/*.dylib plugin/MSPhysics/libraries/stage/osx64/ 2>/dev/null || true
        
        # Copy Ruby extension files
        if [ -d "RubyExtension/MSPhysics" ]; then
          cp -R RubyExtension/MSPhysics/* plugin/MSPhysics/
          cp RubyExtension/MSPhysics.rb plugin/
          echo "âœ“ Ruby extension files"
        else
          echo "ERROR: RubyExtension/MSPhysics not found!"
          ls -la RubyExtension/ || ls -la
          exit 1
        fi
        
        echo -e "\nðŸ“¦ Plugin structure:"
        find plugin -type f | head -30
        
    - name: Create RBZ Package
      run: |
        cd plugin
        zip -r ../MSPhysics-v1.0.3-Modernized.rbz .
        cd ..
        ls -lh MSPhysics-v1.0.3-Modernized.rbz
        
    - name: Upload Complete Plugin
      uses: actions/upload-artifact@v4
      with:
        name: MSPhysics-v1.0.3-Modernized
        path: MSPhysics-v1.0.3-Modernized.rbz
        retention-days: 90
